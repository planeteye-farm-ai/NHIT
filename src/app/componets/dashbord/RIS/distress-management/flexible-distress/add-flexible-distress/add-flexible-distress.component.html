<app-page-header
  title="Add Flexible Distress"
  title1="Add Flexible Distress"
  activeTitle="Add Flexible Distress"
></app-page-header>

<div class="row">
  <div class="col-xl-12">
    <div class="card custom-card">
      <div class="card-header bg-warning text-white">
        <h6 class="card-title mb-0">
          <i class="ri-alert-line me-2"></i>Add Flexible Distress
          <span *ngIf="selectedRoadName" class="text-dark ms-2">
            - {{ selectedRoadName }}
          </span>
        </h6>
      </div>
      <div class="card-body wizard-container">
        <!-- Road & Chainage Outline (Dashboard-like, no map) -->
        <div class="info-outline">
          <div class="outline-title">
            <i class="ri-road-map-line"></i>
            Road & Chainage
          </div>
          <div class="outline-grid">
            <div class="outline-item">
              <div class="outline-label">
                Road <span class="text-danger">*</span>
              </div>
              <select
                class="outline-input"
                [(ngModel)]="selectedRoadName"
                (ngModelChange)="onRoadSelect($event)"
                [ngModelOptions]="{ standalone: true }"
              >
                <option value="" disabled>Select Road</option>
                <option *ngFor="let road of availableRoads" [value]="road">
                  {{ road }}
                </option>
              </select>
            </div>
            <div class="outline-item">
              <div class="outline-label">
                Chainage Start (KM) <span class="text-danger">*</span>
                <span *ngIf="isLoadingChainage" class="text-info ms-1">
                  <i class="ri-loader-4-line ri-spin"></i>
                </span>
              </div>
              <input
                type="number"
                class="outline-input"
                [(ngModel)]="chainageStart"
                (ngModelChange)="updateChainageStart($event)"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Loading..."
                step="0.001"
                min="0"
                [disabled]="isLoadingChainage"
              />
            </div>
            <div class="outline-item">
              <div class="outline-label">
                Chainage End (KM) <span class="text-danger">*</span>
                <span *ngIf="isLoadingChainage" class="text-info ms-1">
                  <i class="ri-loader-4-line ri-spin"></i>
                </span>
              </div>
              <input
                type="number"
                class="outline-input"
                [(ngModel)]="chainageEnd"
                (ngModelChange)="updateChainageEnd($event)"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Loading..."
                step="0.001"
                min="0"
                [disabled]="isLoadingChainage"
              />
            </div>
            <div class="outline-item">
              <div class="outline-label">
                Direction <span class="text-danger">*</span>
              </div>
              <div class="chips">
                <button
                  type="button"
                  class="chip"
                  *ngFor="let direction of directionOptions"
                  [class.selected]="selectedDirection === direction"
                  (click)="selectDirection(direction)"
                >
                  <i
                    class="ri-arrow-left-right-line"
                    *ngIf="
                      direction.includes('Increasing') ||
                      direction.includes('Decreasing')
                    "
                  ></i>
                  <i
                    class="ri-separator"
                    *ngIf="direction.includes('Median')"
                  ></i>
                  <span>{{ getDirectionLabel(direction) }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Distress Type Selection (same as asset cards) -->
        <div class="step-content" style="margin-top: 16px">
          <h3 class="step-title">
            <i class="ri-alert-line"></i>
            Select Distress Type
          </h3>
          <div class="alert alert-warning mb-3" *ngIf="!selectedDirection">
            <i class="ri-error-warning-line me-2"></i>
            <strong>Please select a direction first</strong> from the chips
            above before selecting a distress type.
          </div>
          <div class="alert alert-primary mb-3" *ngIf="selectedDirection">
            <i class="ri-information-line me-2"></i>
            Click on any distress card below to add distress details.
          </div>
          <div class="asset-grid">
            <div
              *ngFor="let distress of distressTypes"
              class="asset-card"
              [class.selected]="selectedDistressType === distress.name"
              (click)="onDistressCardClick(distress.name)"
            >
              <div class="asset-icon" [style.background-color]="distress.color">
                <i [class]="getDistressIconClass(distress.name)"></i>
              </div>
              <div class="asset-info">
                <div class="asset-name">{{ distress.name }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Distress Details -->
<div *ngIf="isModalOpen" class="inventory-modal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h4 class="modal-title">
        <i class="ri-alert-fill"></i>
        Add {{ selectedDistressType }} Details
      </h4>
      <button class="modal-close" (click)="closeModal()">
        <i class="ri-close-line"></i>
      </button>
    </div>
    <div class="modal-body">
      <form [formGroup]="distressForm">
        <div class="row">
          <!-- Carriage Way Lane -->
          <div class="col-md-6 mb-3">
            <label class="form-label">
              Carriage Way Lane <span class="text-danger">*</span>
            </label>
            <select class="form-control" formControlName="carriage_way_lanes">
              <option value="">Select Lane</option>
              <option *ngFor="let lane of laneOptions" [value]="lane">
                {{ lane }}
              </option>
            </select>
          </div>

          <!-- Latitude -->
          <div class="col-md-6 mb-3">
            <label class="form-label">
              Latitude <span class="text-danger">*</span>
            </label>
            <input
              type="number"
              class="form-control"
              formControlName="latitude"
              placeholder="0.000000"
              step="0.000001"
            />
          </div>

          <!-- Longitude -->
          <div class="col-md-6 mb-3">
            <label class="form-label">
              Longitude <span class="text-danger">*</span>
            </label>
            <input
              type="number"
              class="form-control"
              formControlName="longitude"
              placeholder="0.000000"
              step="0.000001"
            />
          </div>

          <!-- Number of Distress -->
          <div class="col-md-6 mb-3">
            <label class="form-label">
              <i class="ri-sort-number-asc me-2"></i>Number of Distress
            </label>
            <input
              type="number"
              class="form-control"
              formControlName="numbers_distress"
              placeholder="0"
              min="0"
            />
          </div>

          <!-- Dimension Length -->
          <div class="col-md-6 mb-3">
            <label class="form-label">
              <i class="ri-ruler-line me-2"></i>Dimension Length (m)
            </label>
            <input
              type="number"
              class="form-control"
              formControlName="dimension_length"
              placeholder="0.00"
              step="0.01"
            />
          </div>

          <!-- Dimension Width -->
          <div class="col-md-6 mb-3">
            <label class="form-label">
              <i class="ri-ruler-line me-2"></i>Dimension Width (m)
            </label>
            <input
              type="number"
              class="form-control"
              formControlName="dimension_width"
              placeholder="0.00"
              step="0.01"
            />
          </div>

          <!-- Dimension Depth -->
          <div class="col-md-12 mb-3">
            <label class="form-label">
              <i class="ri-ruler-line me-2"></i>Dimension Depth (mm)
            </label>
            <input
              type="number"
              class="form-control"
              formControlName="dimension_depth"
              placeholder="0.00"
              step="0.01"
            />
          </div>

          <!-- Image Upload with Drag & Drop -->
          <div class="col-md-6 mb-3">
            <label class="form-label">
              <i class="ri-image-line me-2"></i>Image Upload
            </label>
            <div
              *ngIf="!distressForm.get('image_preview')?.value"
              class="upload-zone"
              [class.dragging]="isDraggingImage"
              (dragover)="onImageDragOver($event)"
              (dragleave)="onImageDragLeave($event)"
              (drop)="onImageDrop($event)"
            >
              <i class="ri-image-add-line upload-icon"></i>
              <p class="upload-text">Drag & drop or click to browse</p>
              <p class="upload-formats">JPG, PNG (Max: 5MB)</p>
              <input
                type="file"
                class="d-none"
                #imageInput
                accept="image/jpeg,image/jpg,image/png"
                (change)="onImageSelected($event)"
              />
              <button
                type="button"
                class="btn btn-sm btn-outline-primary mt-2"
                (click)="imageInput.click()"
              >
                Browse Files
              </button>
            </div>
            <div
              *ngIf="distressForm.get('image_preview')?.value"
              class="upload-preview"
            >
              <img
                [src]="distressForm.get('image_preview')?.value"
                alt="Preview"
                class="preview-image"
              />
              <button
                type="button"
                class="preview-remove"
                (click)="removeImage()"
              >
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>

          <!-- Video Upload with Drag & Drop -->
          <div class="col-md-6 mb-3">
            <label class="form-label">
              <i class="ri-video-line me-2"></i>Video Upload
            </label>
            <div
              *ngIf="!distressForm.get('video_preview')?.value"
              class="upload-zone"
              [class.dragging]="isDraggingVideo"
              (dragover)="onVideoDragOver($event)"
              (dragleave)="onVideoDragLeave($event)"
              (drop)="onVideoDrop($event)"
            >
              <i class="ri-video-add-line upload-icon"></i>
              <p class="upload-text">Drag & drop or click to browse</p>
              <p class="upload-formats">MP4, AVI, MOV, WMV (Max: 50MB)</p>
              <input
                type="file"
                class="d-none"
                #videoInput
                accept="video/mp4,video/avi,video/mov,video/wmv"
                (change)="onVideoSelected($event)"
              />
              <button
                type="button"
                class="btn btn-sm btn-outline-primary mt-2"
                (click)="videoInput.click()"
              >
                Browse Files
              </button>
            </div>
            <div
              *ngIf="distressForm.get('video_preview')?.value"
              class="upload-preview"
            >
              <video
                [src]="distressForm.get('video_preview')?.value"
                class="preview-video"
                controls
              ></video>
              <button
                type="button"
                class="preview-remove"
                (click)="removeVideo()"
              >
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModal()">
        <i class="ri-close-line me-1"></i>Cancel
      </button>
      <button type="button" class="btn btn-info" (click)="debugCanSubmit()">
        <i class="ri-bug-line me-1"></i>Debug
      </button>
      <button
        type="button"
        class="btn btn-primary"
        [disabled]="!canSubmit()"
        (click)="onSubmit()"
        [title]="getSubmitButtonTitle()"
      >
        <i class="ri-save-line me-1"></i>Submit Distress
      </button>
    </div>
  </div>
</div>
