<app-page-header
  title="Add History Of Works"
  title1="Add History Of Works"
  activeTitle="Add History Of Works"
></app-page-header>

<div class="row">
  <div class="col-xl-12">
    <app-showcode-card
      [title]="'Add History Of Works - ' + roadName"
      [prism]="prismCode.formlayouts10"
    >
      <form [formGroup]="historyDataForm" (ngSubmit)="onSubmit()">
        <div class="card custom-card">
          <div class="card-header bg-primary text-white">
            <h6 class="card-title mb-0">
              <i class="ri-tools-line me-2"></i>Work Information
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <!-- Road Dropdown -->
              <div class="col-md-12 mb-3">
                <label class="form-label" for="geometry_data_id">Road</label
                ><span class="text-danger">*</span>
                <select
                  class="form-select"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('geometry_data_id')?.invalid &&
                      historyDataForm.get('geometry_data_id')?.touched
                  }"
                  id="geometry_data_id"
                  formControlName="geometry_data_id"
                  [disabled]="true"
                >
                  <option value="" selected disabled>Select Road</option>
                  @for (road of roadList; track $index) {
                  <option [value]="road.geometry_data_id">
                    {{ road.name_of_road }}
                  </option>
                  }
                </select>
                @if(historyDataForm.get('geometry_data_id')?.invalid &&
                historyDataForm.get('geometry_data_id')?.touched){
                <span class="text-danger">Please select road</span>
                }
                <small class="text-muted">
                  <i class="ri-information-line"></i> Road is pre-selected
                </small>
              </div>

              <!-- Chainage Start -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="chainage_start"
                  >Chainage Start (KM)</label
                ><span class="text-danger">*</span>
                <input
                  type="number"
                  step="0.001"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('chainage_start')?.invalid &&
                      historyDataForm.get('chainage_start')?.touched
                  }"
                  id="chainage_start"
                  formControlName="chainage_start"
                  placeholder="0.000"
                />
                @if(historyDataForm.get('chainage_start')?.invalid &&
                historyDataForm.get('chainage_start')?.touched){
                <span class="text-danger">Please enter chainage start</span>
                }
              </div>

              <!-- Chainage End -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="chainage_end"
                  >Chainage End (KM)</label
                ><span class="text-danger">*</span>
                <input
                  type="number"
                  step="0.001"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('chainage_end')?.invalid &&
                      historyDataForm.get('chainage_end')?.touched
                  }"
                  id="chainage_end"
                  formControlName="chainage_end"
                  placeholder="0.000"
                />
                @if(historyDataForm.get('chainage_end')?.invalid &&
                historyDataForm.get('chainage_end')?.touched){
                <span class="text-danger">Please enter chainage end</span>
                }
              </div>

              <!-- Direction -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="direction">Direction</label
                ><span class="text-danger">*</span>
                <select
                  class="form-select"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('direction')?.invalid &&
                      historyDataForm.get('direction')?.touched
                  }"
                  id="direction"
                  formControlName="direction"
                >
                  <option value="" selected disabled>Select Direction</option>
                  @for (dir of directionOptions; track $index) {
                  <option value="{{ dir }}">{{ dir }}</option>
                  }
                </select>
                @if(historyDataForm.get('direction')?.invalid &&
                historyDataForm.get('direction')?.touched){
                <span class="text-danger">Please select direction</span>
                }
              </div>

              <!-- Type of Work -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="type_of_work">Type of Work</label
                ><span class="text-danger">*</span>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('type_of_work')?.invalid &&
                      historyDataForm.get('type_of_work')?.touched
                  }"
                  id="type_of_work"
                  formControlName="type_of_work"
                  placeholder="Enter type of work (e.g., Resurfacing, Repair)"
                />
                @if(historyDataForm.get('type_of_work')?.invalid &&
                historyDataForm.get('type_of_work')?.touched){
                <span class="text-danger">Please enter type of work</span>
                }
              </div>

              <!-- Name of Contractor -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="name_of_contractor"
                  >Name of Contractor</label
                ><span class="text-danger">*</span>
                <input
                  type="text"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('name_of_contractor')?.invalid &&
                      historyDataForm.get('name_of_contractor')?.touched
                  }"
                  id="name_of_contractor"
                  formControlName="name_of_contractor"
                  placeholder="Enter contractor name"
                />
                @if(historyDataForm.get('name_of_contractor')?.invalid &&
                historyDataForm.get('name_of_contractor')?.touched){
                <span class="text-danger">Please enter contractor name</span>
                }
              </div>

              <!-- Asset Type -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="asset_type">Asset Type</label
                ><span class="text-danger">*</span>
                <select
                  class="form-select"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('asset_type')?.invalid &&
                      historyDataForm.get('asset_type')?.touched
                  }"
                  id="asset_type"
                  formControlName="asset_type"
                  (change)="onAssetTypeChange($any($event.target).value)"
                >
                  <option value="" selected disabled>Select Asset Type</option>
                  @for (asset of assetTypes; track $index) {
                  <option value="{{ asset }}">{{ asset }}</option>
                  }
                </select>
                @if(historyDataForm.get('asset_type')?.invalid &&
                historyDataForm.get('asset_type')?.touched){
                <span class="text-danger">Please select asset type</span>
                }
              </div>

              <!-- Sub Asset Type -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="sub_asset_type"
                  >Sub Asset Type</label
                ><span class="text-danger">*</span>
                <select
                  class="form-select"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('sub_asset_type')?.invalid &&
                      historyDataForm.get('sub_asset_type')?.touched
                  }"
                  id="sub_asset_type"
                  formControlName="sub_asset_type"
                  [disabled]="subAssetTypes.length === 0"
                >
                  <option value="" selected disabled>
                    Select Sub Asset Type
                  </option>
                  @for (subAsset of subAssetTypes; track $index) {
                  <option value="{{ subAsset }}">{{ subAsset }}</option>
                  }
                </select>
                @if(historyDataForm.get('sub_asset_type')?.invalid &&
                historyDataForm.get('sub_asset_type')?.touched){
                <span class="text-danger">Please select sub asset type</span>
                } @if(subAssetTypes.length === 0 &&
                !historyDataForm.get('asset_type')?.value){
                <small class="text-muted">
                  <i class="ri-information-line"></i> Please select Asset Type
                  first
                </small>
                }
              </div>

              <!-- Latitude -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="latitude">Latitude</label
                ><span class="text-danger">*</span>
                <input
                  type="number"
                  step="0.000001"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('latitude')?.invalid &&
                      historyDataForm.get('latitude')?.touched
                  }"
                  id="latitude"
                  formControlName="latitude"
                  placeholder="e.g., 26.515600"
                />
                @if(historyDataForm.get('latitude')?.invalid &&
                historyDataForm.get('latitude')?.touched){
                <span class="text-danger">Please enter valid latitude</span>
                }
              </div>

              <!-- Longitude -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="longitude">Longitude</label
                ><span class="text-danger">*</span>
                <input
                  type="number"
                  step="0.000001"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('longitude')?.invalid &&
                      historyDataForm.get('longitude')?.touched
                  }"
                  id="longitude"
                  formControlName="longitude"
                  placeholder="e.g., 77.812300"
                />
                @if(historyDataForm.get('longitude')?.invalid &&
                historyDataForm.get('longitude')?.touched){
                <span class="text-danger">Please enter valid longitude</span>
                }
              </div>

              <!-- Numbers/Lengths -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="numbers_lengths"
                  >Numbers/Lengths (Inventories)</label
                >
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('numbers_lengths')?.invalid &&
                      historyDataForm.get('numbers_lengths')?.touched
                  }"
                  id="numbers_lengths"
                  formControlName="numbers_lengths"
                  placeholder="Enter quantity or length"
                />
                @if(historyDataForm.get('numbers_lengths')?.invalid &&
                historyDataForm.get('numbers_lengths')?.touched){
                <span class="text-danger"
                  >Please enter valid number/length</span
                >
                }
              </div>

              <!-- Work Status -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="work_status">Work Status</label
                ><span class="text-danger">*</span>
                <select
                  class="form-select"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('work_status')?.invalid &&
                      historyDataForm.get('work_status')?.touched
                  }"
                  id="work_status"
                  formControlName="work_status"
                >
                  <option value="" selected disabled>Select Work Status</option>
                  @for (status of workStatusOptions; track $index) {
                  <option value="{{ status }}">{{ status }}</option>
                  }
                </select>
                @if(historyDataForm.get('work_status')?.invalid &&
                historyDataForm.get('work_status')?.touched){
                <span class="text-danger">Please select work status</span>
                }
              </div>

              <!-- Work Start Date -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="work_start_date"
                  >Work Start Date</label
                ><span class="text-danger">*</span>
                <input
                  type="date"
                  [max]="currentDate"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('work_start_date')?.invalid &&
                      historyDataForm.get('work_start_date')?.touched
                  }"
                  id="work_start_date"
                  formControlName="work_start_date"
                />
                @if(historyDataForm.get('work_start_date')?.invalid &&
                historyDataForm.get('work_start_date')?.touched){
                <span class="text-danger">Please select work start date</span>
                }
              </div>

              <!-- Work End Date -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="work_end_date"
                  >Work End Date</label
                ><span class="text-danger">*</span>
                <input
                  type="date"
                  [max]="currentDate"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('work_end_date')?.invalid &&
                      historyDataForm.get('work_end_date')?.touched
                  }"
                  id="work_end_date"
                  formControlName="work_end_date"
                />
                @if(historyDataForm.get('work_end_date')?.invalid &&
                historyDataForm.get('work_end_date')?.touched){
                <span class="text-danger">Please select work end date</span>
                }
              </div>

              <!-- Comments -->
              <div class="col-md-12 mb-3">
                <label class="form-label" for="comments">Comments</label
                ><span class="text-danger">*</span>
                <textarea
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      historyDataForm.get('comments')?.invalid &&
                      historyDataForm.get('comments')?.touched
                  }"
                  id="comments"
                  formControlName="comments"
                  rows="3"
                  placeholder="Enter comments about the work"
                ></textarea>
                @if(historyDataForm.get('comments')?.invalid &&
                historyDataForm.get('comments')?.touched){
                <span class="text-danger">Please enter comments</span>
                }
              </div>

              <!-- Image Upload -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="work_image"
                  >Work Image (JPG/PNG)</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="work_image"
                  accept=".jpg,.jpeg,.png"
                  (change)="onImageSelected($event)"
                />
                @if(historyDataForm.get('image_preview')?.value) {
                <div class="mt-2 position-relative" style="max-width: 200px">
                  <img
                    [src]="historyDataForm.get('image_preview')?.value"
                    alt="Image Preview"
                    class="img-thumbnail"
                    style="max-width: 100%"
                  />
                  <button
                    type="button"
                    class="btn btn-sm btn-danger position-absolute top-0 end-0"
                    (click)="removeImage()"
                    style="margin: 5px"
                  >
                    <i class="ri-close-line"></i>
                  </button>
                </div>
                }
              </div>

              <!-- Video Upload -->
              <div class="col-md-6 mb-3">
                <label class="form-label" for="work_video"
                  >Work Video (MP4/AVI/MOV/WMV)</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="work_video"
                  accept=".mp4,.avi,.mov,.wmv"
                  (change)="onVideoSelected($event)"
                />
                @if(historyDataForm.get('video_preview')?.value) {
                <div class="mt-2 position-relative" style="max-width: 300px">
                  <video
                    [src]="historyDataForm.get('video_preview')?.value"
                    controls
                    class="img-thumbnail"
                    style="max-width: 100%"
                  ></video>
                  <button
                    type="button"
                    class="btn btn-sm btn-danger position-absolute top-0 end-0"
                    (click)="removeVideo()"
                    style="margin: 5px"
                  >
                    <i class="ri-close-line"></i>
                  </button>
                </div>
                }
              </div>

              <!-- Submit Button -->
              <div
                class="col-md-12 d-flex align-items-end flex-column mb-3 mt-2"
              >
                <div class="d-flex gap-2">
                  <button
                    type="submit"
                    class="btn btn-primary"
                    [disabled]="historyDataForm.invalid"
                  >
                    <i class="ri-save-line me-1"></i> Submit
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    [routerLink]="['/ris/road-manage/history-of-work', roadId]"
                  >
                    <i class="ri-close-line me-1"></i> Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </app-showcode-card>
  </div>
</div>
