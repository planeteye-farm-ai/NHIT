<app-page-header
  *ngIf="!embeddedMode"
  title="Add Road Inventory"
  title1="Add Road Inventory"
  activeTitle="Add Road Inventory"
></app-page-header>

<div class="row">
  <div class="col-xl-12">
        <div class="card custom-card">
          <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
            <h6 class="card-title mb-0">
              <i class="ri-add-circle-line me-2"></i>Add Inventory - {{ roadName }}
            </h6>
            <button
              *ngIf="embeddedMode"
              type="button"
              class="btn btn-sm btn-light"
              (click)="formClosed.emit()"
              title="Close form">
              <i class="ri-close-line"></i> Close
            </button>
          </div>
      <div class="card-body wizard-container">
        <!-- ONE-STEP LAYOUT -->

        <!-- Road & Chainage Outline (Dashboard-like, no map) -->
        <div class="info-outline">
          <div class="outline-title">
            <i class="ri-road-map-line"></i>
            Road & Chainage
          </div>
          <div class="outline-grid">
            <div class="outline-item">
              <div class="outline-label">Road</div>
              <div class="outline-value">{{ roadName || "Loading..." }}</div>
            </div>
            <div class="outline-item">
              <div class="outline-label">
                Chainage Start (KM) <span class="text-danger">*</span>
                <span *ngIf="isLoadingChainage" class="text-info ms-1">
                  <i class="ri-loader-4-line ri-spin"></i>
                </span>
              </div>
              <input
                type="number"
                class="outline-input"
                [(ngModel)]="chainageStart"
                (ngModelChange)="updateChainageStart($event)"
                placeholder="Loading..."
                step="0.001"
                min="0"
                [disabled]="isLoadingChainage"
              />
            </div>
            <div class="outline-item">
              <div class="outline-label">
                Chainage End (KM) <span class="text-danger">*</span>
                <span *ngIf="isLoadingChainage" class="text-info ms-1">
                  <i class="ri-loader-4-line ri-spin"></i>
                </span>
              </div>
              <input
                type="number"
                class="outline-input"
                [(ngModel)]="chainageEnd"
                (ngModelChange)="updateChainageEnd($event)"
                placeholder="Loading..."
                step="0.001"
                min="0"
                [disabled]="isLoadingChainage"
              />
            </div>
            <div class="outline-item">
              <div class="outline-label">
                Direction <span class="text-danger">*</span>
              </div>
              <div class="chips">
                <button
                  type="button"
                  class="chip"
                  *ngFor="let direction of directionOptions"
                  [class.selected]="selectedDirection === direction"
                  (click)="selectDirection(direction)"
                >
                  <i
                    class="ri-arrow-left-right-line"
                    *ngIf="
                      direction.includes('Increasing') ||
                      direction.includes('Decreasing')
                    "
                  ></i>
                  <i
                    class="ri-separator"
                    *ngIf="direction.includes('Median')"
                  ></i>
                  <span>{{ getDirectionLabel(direction) }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Asset Selection (same as dashboard cards) -->
        <div class="step-content" style="margin-top: 16px">
          <h3 class="step-title">
            <i class="ri-dashboard-line"></i>
            Select Asset Type
          </h3>
          <div class="alert alert-warning mb-3" *ngIf="!selectedDirection">
            <i class="ri-error-warning-line me-2"></i>
            <strong>Please select a direction first</strong> from the chips
            above before selecting an asset.
          </div>
          <div class="alert alert-primary mb-3" *ngIf="selectedDirection">
            <i class="ri-information-line me-2"></i>
            Click on any asset card below to add inventory details for that
            asset type.
          </div>
          <div class="asset-grid">
            <div
              *ngFor="let asset of assetTypes"
              class="asset-card"
              [class.selected]="selectedAsset === asset.name"
              (click)="onAssetCardClick(asset.name)"
            >
              <div class="asset-icon" [style.background-color]="asset.color">
                <i [class]="getAssetIconClass(asset.name)"></i>
              </div>
              <div class="asset-info">
                <div class="asset-name">{{ asset.name }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Sub Asset Selection and Inventory Form -->
<div *ngIf="isModalOpen" class="inventory-modal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h4 class="modal-title">
        <i class="ri-add-box-line"></i>
        Add {{ selectedAsset }} Inventory
      </h4>
      <button class="modal-close" (click)="closeModal()">
        <i class="ri-close-line"></i>
      </button>
    </div>
    <div class="modal-body">
      <form [formGroup]="inventoryForm">
            <div class="row">
          <!-- Sub Asset Type Cards (only show if subtypes exist) -->
          <div class="col-md-12 mb-4" *ngIf="subAssetTypes.length > 0">
            <label class="form-label mb-3">
              <i class="ri-stack-line me-2"></i>Select Sub Asset Type(s)<span
                class="text-danger"
                >*</span
              >
              <small class="text-muted ms-2">(Click to select multiple)</small>
            </label>
            <div class="sub-asset-grid">
              <div
                *ngFor="let subAsset of subAssetTypes"
                class="sub-asset-card"
                [class.selected]="isSubAssetSelected(subAsset)"
                (click)="toggleSubAsset(subAsset)"
              >
                <div class="sub-asset-icon">
                  <i
                    class="ri-checkbox-circle-line"
                    *ngIf="!isSubAssetSelected(subAsset)"
                  ></i>
                  <i
                    class="ri-checkbox-circle-fill"
                    *ngIf="isSubAssetSelected(subAsset)"
                  ></i>
                </div>
                <div class="sub-asset-label">{{ subAsset }}</div>
              </div>
            </div>
            <span *ngIf="selectedSubAssets.length === 0" class="text-danger">
              Please select at least one sub asset type
            </span>
              </div>

          <!-- Details for Each Selected Sub-Asset -->
          <div class="col-md-12" *ngIf="selectedSubAssets.length > 0">
            <div
              *ngFor="let subAsset of selectedSubAssets"
              class="sub-asset-details-card mb-4"
            >
              <div class="sub-asset-details-header">
                <h6>
                  <i class="ri-map-pin-line me-2"></i>
                  {{ subAsset }}
                </h6>
                <button
                  type="button"
                  class="btn-remove-sub-asset"
                  (click)="toggleSubAsset(subAsset)"
                >
                  <i class="ri-close-line"></i>
                </button>
              </div>
              <div class="row">
              <div class="col-md-6 mb-3">
                  <label class="form-label">
                    Latitude<span class="text-danger">*</span>
                  </label>
                <input
                  type="number"
                  class="form-control"
                    [ngModel]="subAssetDetails[subAsset].latitude"
                    (ngModelChange)="updateSubAssetLatitude(subAsset, $event)"
                    [ngModelOptions]="{ standalone: true }"
                    placeholder="0.000000"
                    step="0.000001"
                  />
              </div>
              <div class="col-md-6 mb-3">
                  <label class="form-label">
                    Longitude<span class="text-danger">*</span>
                  </label>
                <input
                  type="number"
                  class="form-control"
                    [ngModel]="subAssetDetails[subAsset].longitude"
                    (ngModelChange)="updateSubAssetLongitude(subAsset, $event)"
                    [ngModelOptions]="{ standalone: true }"
                    placeholder="0.000000"
                    step="0.000001"
                  />
              </div>
                <div class="col-md-12 mb-3">
                  <label class="form-label">
                    <i class="ri-sort-number-asc me-2"></i>Quantity
                  </label>
                  <div class="quantity-control">
                    <button
                      type="button"
                      class="quantity-btn"
                      (click)="decrementSubAssetQuantity(subAsset)"
                    >
                      <i class="ri-subtract-line"></i>
                    </button>
                  <input
                      type="number"
                      class="quantity-input"
                      [ngModel]="subAssetDetails[subAsset].quantity"
                      (ngModelChange)="updateSubAssetQuantity(subAsset, $event)"
                      [ngModelOptions]="{ standalone: true }"
                      placeholder="0"
                      min="0"
                    />
                    <button
                      type="button"
                      class="quantity-btn"
                      (click)="incrementSubAssetQuantity(subAsset)"
                    >
                      <i class="ri-add-line"></i>
                    </button>
                  </div>
                </div>
                </div>
                </div>
              </div>

          <!-- Info message for assets without subtypes -->
          <div class="col-md-12 mb-3" *ngIf="subAssetTypes.length === 0">
            <div class="alert alert-info">
              <i class="ri-information-line me-2"></i>
              <strong>{{ selectedAsset }}</strong> does not have sub-types. Fill
              in the details below.
              </div>
              </div>

          <!-- Latitude and Longitude (only for assets without subtypes) -->
          <div class="col-md-6 mb-3" *ngIf="subAssetTypes.length === 0">
            <label class="form-label" for="latitude">
              Latitude<span class="text-danger">*</span>
            </label>
                <input
                  type="number"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      inventoryForm.get('latitude')?.invalid &&
                      inventoryForm.get('latitude')?.touched
                  }"
                  id="latitude"
                  formControlName="latitude"
                  placeholder="0.000000"
                  step="0.000001"
                />
            <span
              *ngIf="
                inventoryForm.get('latitude')?.invalid &&
                inventoryForm.get('latitude')?.touched
              "
              class="text-danger"
            >
              Please enter latitude
            </span>
              </div>

          <!-- Longitude (only for assets without subtypes) -->
          <div class="col-md-6 mb-3" *ngIf="subAssetTypes.length === 0">
            <label class="form-label" for="longitude">
              Longitude<span class="text-danger">*</span>
            </label>
                <input
                  type="number"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      inventoryForm.get('longitude')?.invalid &&
                      inventoryForm.get('longitude')?.touched
                  }"
                  id="longitude"
                  formControlName="longitude"
                  placeholder="0.000000"
                  step="0.000001"
                />
            <span
              *ngIf="
                inventoryForm.get('longitude')?.invalid &&
                inventoryForm.get('longitude')?.touched
              "
              class="text-danger"
            >
              Please enter longitude
            </span>
              </div>

          <!-- Numbers (Inventories) with Increment/Decrement (only for assets without subtypes) -->
          <div class="col-md-12 mb-4" *ngIf="subAssetTypes.length === 0">
            <label class="form-label">
              <i class="ri-sort-number-asc me-2"></i>Quantity
            </label>
            <div class="quantity-control">
              <button
                type="button"
                class="quantity-btn quantity-minus"
                (click)="decrementQuantity()"
              >
                <i class="ri-subtract-line"></i>
              </button>
                <input
                  type="number"
                class="quantity-input"
                  formControlName="numbers_inventory"
                placeholder="0"
                min="0"
              />
              <button
                type="button"
                class="quantity-btn quantity-plus"
                (click)="incrementQuantity()"
              >
                <i class="ri-add-line"></i>
              </button>
            </div>
            <small class="text-muted">
              <i class="ri-information-line me-1"></i>Use the + and - buttons to
              adjust quantity
            </small>
              </div>

          <!-- Image Upload with Drag & Drop (common for all assets) -->
              <div class="col-md-6 mb-3">
            <label class="form-label">
              <i class="ri-image-line me-2"></i>Image Upload
              <small
                class="text-muted ms-2"
                *ngIf="selectedSubAssets.length > 1"
                >(Shared for all selected)</small
              >
            </label>
            <div
              *ngIf="!inventoryForm.get('image_preview')?.value"
              class="upload-zone"
              [class.dragging]="isDraggingImage"
              (dragover)="onImageDragOver($event)"
              (dragleave)="onImageDragLeave($event)"
              (drop)="onImageDrop($event)"
              (click)="imageFileInput.click()"
            >
              <div class="upload-icon">
                <i class="ri-image-add-line"></i>
              </div>
              <div class="upload-text">
                <span class="upload-main">Drop image here</span>
                <span class="upload-sub">or click to browse</span>
              </div>
              <div class="upload-formats">JPG, PNG (Max 5MB)</div>
            </div>
                <input
                  type="file"
              #imageFileInput
              class="d-none"
                  accept=".jpg,.jpeg,.png"
                  (change)="onImageSelected($event)"
                />
            <div
              *ngIf="inventoryForm.get('image_preview')?.value"
              class="upload-preview"
            >
                  <img
                    [src]="inventoryForm.get('image_preview')?.value"
                    alt="Image Preview"
                class="preview-image"
                  />
                  <button
                    type="button"
                class="preview-remove"
                    (click)="removeImage()"
                  >
                <i class="ri-delete-bin-line"></i>
                  </button>
                </div>
              </div>

          <!-- Video Upload with Drag & Drop (common for all assets) -->
              <div class="col-md-6 mb-3">
            <label class="form-label">
              <i class="ri-video-line me-2"></i>Video Upload
              <small
                class="text-muted ms-2"
                *ngIf="selectedSubAssets.length > 1"
                >(Shared for all selected)</small
              >
            </label>
            <div
              *ngIf="!inventoryForm.get('video_preview')?.value"
              class="upload-zone"
              [class.dragging]="isDraggingVideo"
              (dragover)="onVideoDragOver($event)"
              (dragleave)="onVideoDragLeave($event)"
              (drop)="onVideoDrop($event)"
              (click)="videoFileInput.click()"
            >
              <div class="upload-icon">
                <i class="ri-video-add-line"></i>
              </div>
              <div class="upload-text">
                <span class="upload-main">Drop video here</span>
                <span class="upload-sub">or click to browse</span>
              </div>
              <div class="upload-formats">MP4, AVI, MOV (Max 50MB)</div>
            </div>
                <input
                  type="file"
              #videoFileInput
              class="d-none"
                  accept=".mp4,.avi,.mov,.wmv"
                  (change)="onVideoSelected($event)"
                />
            <div
              *ngIf="inventoryForm.get('video_preview')?.value"
              class="upload-preview"
            >
                  <video
                    [src]="inventoryForm.get('video_preview')?.value"
                    controls
                class="preview-video"
                  ></video>
                  <button
                    type="button"
                class="preview-remove"
                    (click)="removeVideo()"
                  >
                <i class="ri-delete-bin-line"></i>
                  </button>
                </div>
              </div>
            </div>
      </form>
          </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModal()">
        <i class="ri-close-line me-1"></i>Cancel
      </button>
      <button type="button" class="btn btn-info" (click)="debugCanSubmit()">
        <i class="ri-bug-line me-1"></i>Debug
            </button>
            <button
              type="button"
        class="btn btn-primary"
        [disabled]="!canSubmit()"
        (click)="onSubmitFromModal()"
        [title]="getSubmitButtonTitle()"
      >
        <i class="ri-save-line me-1"></i>Submit Inventory
        <span
          *ngIf="selectedSubAssets.length > 1"
          class="badge bg-light text-dark ms-2"
        >
          {{ selectedSubAssets.length }} items
        </span>
            </button>
          </div>
  </div>
</div>
