<div class="dashboard-container">
  <!-- Main Content Area -->
    <!-- Dashboard Content (always show) -->
    <div>
    <!-- Filter Containers -->
    <div class="filters-container">
      <!-- Main Filters Container (80% width) -->
      <div class="main-filters-container">
        <div class="filter-row-main">
          <div class="filter-group">
            <label>Project Name:</label>
            <select [value]="filters.projectName" (change)="onProjectChange($event)" class="filter-select">
              <option *ngFor="let project of availableProjects" [value]="project">{{ project }}</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Date:</label>
            <select [value]="filters.date" (change)="onDateChange($event)" class="filter-select">
              <option *ngFor="let date of availableDates" [value]="date">{{ date }}</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Direction:</label>
            <select [value]="filters.direction" (change)="onDirectionChange($any($event.target).value)" class="filter-select">
              <option value="Increasing">Increasing</option>
              <option value="Decreasing">Decreasing</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Pavement Type:</label>
            <select [value]="filters.pavementType" (change)="onPavementTypeChange($event)" class="filter-select">
              <option value="All">All</option>
              <option *ngFor="let type of availablePavementTypes" [value]="type">{{ type }}</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Lane:</label>
            <select [value]="filters.lane" (change)="onLaneChange($event)" class="filter-select">
              <option value="All">All</option>
              <option *ngFor="let lane of availableLanes" [value]="lane">{{ lane }}</option>
            </select>
          </div>
          
          <div class="filter-group chainage-range-group">
            <!-- <label class="chainage-range-label">Chainage: {{ filters.chainageRange.min.toFixed(3) }} - {{ filters.chainageRange.max.toFixed(3) }}</label> -->
            <div class="chainage-inputs">
              <input 
                type="number" 
                [min]="getChainageMin()" 
                [max]="filters.chainageRange.max" 
                [value]="filters.chainageRange.min"
                (input)="onChainageMinChange($event)"
                class="chainage-input"
                step="0.001">
              <input 
                type="number" 
                [min]="filters.chainageRange.min" 
                [max]="getChainageMax()" 
                [value]="filters.chainageRange.max"
                (input)="onChainageMaxChange($event)"
                class="chainage-input"
                step="0.001">
            </div>
            <div class="chainage-slider-container">
              <input 
                type="range" 
                [min]="getChainageMin()" 
                [max]="getChainageMax()" 
                [value]="filters.chainageRange.min"
                (input)="onChainageMinSliderChange($event)"
                class="chainage-slider">
              <input 
                type="range" 
                [min]="getChainageMin()" 
                [max]="getChainageMax()" 
                [value]="filters.chainageRange.max"
                (input)="onChainageMaxSliderChange($event)"
                class="chainage-slider">
            </div>
          </div>

          <div class="filter-group filter-group-download-kml">
            <button 
              class="comparison-chart-btn download-kml-btn"
              (click)="downloadKml()"
              [disabled]="isLoadingKml || !filters.projectName || !filters.date"
              title="Download KML for current filters"
            >
              <!-- <i *ngIf="!isLoadingKml" class="fas fa-download"></i> -->
              <i *ngIf="isLoadingKml" class="fas fa-spinner fa-spin"></i>
              {{ isLoadingKml ? 'Downloading…' : 'Download KML' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Sidebar Toggle -->
    <!-- <button class="sidebar-toggle" (click)="toggleSidebar()">
      <span class="hamburger-icon">☰</span>
    </button> -->

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" [class.active]="isSidebarOpen" (click)="toggleSidebar()"></div>

    <!-- Main Dashboard Container -->
    <div class="main-dashboard-container">
      <!-- Left Panel (70% width) -->
      <div class="left-panel">
        <!-- Chainage Wise Distress Chart -->
        <!-- <div class="chart-container">
          <div class="chart-wrapper">
            <div echarts [options]="chartOptions" class="echarts-chart"></div>
          </div>
        </div> -->

        <!-- Actual Distress Map -->
        <div class="map-container">
          <div class="chart-header">
            <h3>Location wise Distress Distribution</h3>
            <div class="chart-header-buttons">
              <!-- <button 
                class="street-view-btn"
                (mousedown)="onStreetViewBtnMouseDown($event)"
                (mouseup)="onStreetViewBtnMouseUp()"
                (mouseleave)="onStreetViewBtnMouseLeave()"
                (click)="onStreetViewBtnClick($event)"
                [disabled]="!filters.date || !isMapReady"
                title="Hold to show Street View coverage; click to open at map center"
              >
                <i class="fas fa-street-view" aria-hidden="true"></i>
                Street View
              </button> -->
              <button 
                class="comparison-chart-btn"
                (click)="openChainageComparisonModal()"
                title="View Chainage Comparison Chart"
              >
                <i class="fas fa-chart-line"></i>
                Chainage Comparison
              </button>
            </div>
          </div>
          <div class="map-wrapper">
            <div class="section-loading-overlay" *ngIf="isLoading">
              <div class="section-loading-content">
                <div class="loading-spinner small"></div>
                <p>Loading map data…</p>
              </div>
            </div>
            <div *ngIf="!filters.date" class="map-placeholder">
              <p>Select a date to view map data</p>
            </div>
            <div *ngIf="filters.date && rawData.length === 0" class="map-placeholder">
              <div class="loading-spinner"></div>
              <p>Loading map data...</p>
            </div>
            <div *ngIf="filters.date" id="mapContainer" class="map" [class.map-hidden]="isStreetViewModalOpen || streetViewCoverageMode"></div>
            <!-- Street View coverage layer (hold Street View button): blue lines show where Street View is available; click a point to open -->
            <div class="street-view-coverage-overlay" *ngIf="streetViewCoverageMode && filters.date">
              <div id="streetViewCoverageMapContainer" class="street-view-coverage-map"></div>
              <div class="street-view-coverage-hint">Click on a blue road to open Street View</div>
              <button type="button" class="street-view-exit-coverage-btn" (click)="exitStreetViewCoverageMode()" title="Back to map">
                <i class="fas fa-times"></i> Back to map
              </button>
            </div>
            <!-- Street View directly on the map -->
            <div class="street-view-inline" *ngIf="isStreetViewModalOpen">
              <div *ngIf="streetViewError" class="street-view-inline-error">{{ streetViewError }}</div>
              <div *ngIf="isLoadingStreetView" class="street-view-inline-loading">
                <div class="loading-spinner"></div>
                <p>Loading Street View…</p>
              </div>
              <div *ngIf="!streetViewError" id="streetViewContainer" class="street-view-panorama-inline"></div>
              <button type="button" class="street-view-exit-btn" (click)="closeStreetView()" title="Exit Street View">
                <i class="fas fa-times"></i> Exit Street View
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel (30% width) -->
      <div class="right-panel" [class.sidebar-open]="isSidebarOpen">
        <div class="asset-summary">
          <div class="asset-summary-header">
            <h3>Distress Summary</h3>
            <div class="header-buttons">
              <button 
                class="month-comparison-toggle"
                [class.active]="isMonthComparisonMode"
                [class.loading]="isPreloadingMonthData"
                (click)="toggleMonthComparisonMode()"
                title="{{ isMonthComparisonMode ? 'Click to disable month comparison mode' : 'Click to enable month comparison mode' }}"
              >
                <i *ngIf="!isPreloadingMonthData" class="fas fa-calendar-alt"></i>
                <i *ngIf="isPreloadingMonthData" class="fas fa-spinner fa-spin"></i>
                <span class="toggle-label">{{ isMonthComparisonMode ? 'ON' : 'OFF' }}</span>
              </button>
              <!-- <button 
                class="pothole-detection-btn"
                (click)="openPotholeDetection()"
                title="View Pothole Detection Analysis"
              >
                <i class="fas fa-road"></i>
                <span>Distress</span>
              </button> -->
            </div>
          </div>
          <div class="asset-grid mobile-grid">
            <div class="section-loading-overlay" *ngIf="isLoading">
              <div class="section-loading-content">
                <div class="loading-spinner small"></div>
                <p>Loading distress data…</p>
              </div>
            </div>
            <div *ngIf="!filters.date" class="asset-placeholder">
              <p>Select a date to view distress data</p>
            </div>
            <div *ngIf="filters.date && rawData.length === 0" class="asset-placeholder">
              <div class="loading-spinner"></div>
              <p>Loading distress data...</p>
            </div>
            <div 
              *ngFor="let distress of distressSummary" 
              class="asset-card"
              [class.selected]="selectedDistressType === distress.name"
              (click)="onDistressCardClick(distress)">
              <div class="asset-info">
                <div class="asset-name">{{ distress.name }}</div>
                <div class="asset-count">
                  {{ formatDistressCount(distress) }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chainage Comparison Chart Modal -->
    <div *ngIf="isChainageComparisonModalOpen" class="modal-backdrop comparison-modal-backdrop" (click)="closeChainageComparisonModal()">
      <div class="modal-content comparison-modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            <i class="fas fa-chart-line"></i>
            Distress Distribution Along Chainage
          </h3>
          <button class="modal-close-btn" (click)="closeChainageComparisonModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="modal-body comparison-modal-body">
          <!-- Horizontal Layout Container -->
          <div class="horizontal-layout-container">
            <!-- Left Sidebar: Distress Selection Icons -->
            <div class="asset-selection-sidebar">
              <div class="sidebar-header">
                <h4>
                  <i class="fas fa-layer-group"></i>
                  Distress Types
                </h4>
                <span class="selection-count">{{ selectedDistressesForComparison.length }}/5</span>
              </div>
              <div class="asset-icons-vertical">
                <div
                  *ngFor="let distress of availableDistressesForComparison"
                  class="asset-icon-wrapper"
                  [class.selected]="isDistressSelectedForComparison(distress)"
                  (click)="toggleDistressForComparison(distress)"
                  [title]="distress"
                >
                  <div class="asset-icon-circle" [style.background-color]="getDistressIconColor(distress)">
                    <i [class]="getDistressIconClass(distress)"></i>
                  </div>
                  <span class="asset-icon-label">{{ distress }}</span>
                  <div *ngIf="isDistressSelectedForComparison(distress)" class="selected-indicator">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Content: Chart -->
            <div class="chart-content-area">
              <!-- Comparison Chart -->
              <div class="comparison-chart-container">
                <div *ngIf="selectedDistressesForComparison.length === 0" class="no-assets-selected">
                  <p>Please select at least one distress type to view the comparison chart</p>
                </div>
                <div 
                  *ngIf="selectedDistressesForComparison.length > 0 && chainageComparisonChartOptions && chainageComparisonChartOptions.series" 
                  echarts 
                  [options]="chainageComparisonChartOptions" 
                  class="comparison-echarts-chart"
                  style="background: rgba(0,0,0,0.2);"
                ></div>
                <div *ngIf="selectedDistressesForComparison.length > 0 && (!chainageComparisonChartOptions || !chainageComparisonChartOptions.series)" class="loading-chart">
                  <div class="loading-spinner"></div>
                  <p>Generating chart...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Chart Legend Info -->
          <!-- <div *ngIf="selectedDistressesForComparison.length > 0" class="chart-info">
            <p>
              <i class="fas fa-info-circle"></i>
              Showing distribution from <strong>{{ getChainageMin().toFixed(2) }} KM</strong> to 
              <strong>{{ getChainageMax().toFixed(2) }} KM</strong>
            </p>
          </div> -->
        </div>
      </div>
    </div>

    <!-- Month-wise Comparison Chart Modal -->
    <div *ngIf="isMonthComparisonModalOpen" class="modal-backdrop comparison-modal-backdrop" (click)="closeMonthComparisonModal()">
      <div class="modal-content comparison-modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            <i class="fas fa-calendar-alt"></i>
            <span *ngIf="selectedDistressesForMonthComparison.length === 1">{{ selectedDistressesForMonthComparison[0] }} - Month-wise Comparison</span>
            <span *ngIf="selectedDistressesForMonthComparison.length !== 1">Distress Distribution - Month-wise Comparison</span>
          </h3>
          <button class="modal-close-btn" (click)="closeMonthComparisonModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="modal-body comparison-modal-body">
          <div *ngIf="showDistressSelectionInModal" class="asset-selection-section">
            <div class="asset-selection-header">
              <h4>Select Distress Types to Compare (Max 5):</h4>
              <span class="selection-count">{{ selectedDistressesForMonthComparison.length }}/5 Selected</span>
            </div>
            <div class="asset-chips-container">
              <button
                *ngFor="let distress of distressSummary"
                class="asset-chip"
                [class.selected]="isDistressSelectedForMonthComparison(distress.name)"
                [style.border-color]="getDistressColor(distress.name)"
                [style.background-color]="getDistressChipBackgroundColorForMonth(distress.name)"
                (click)="toggleDistressForMonthComparison(distress.name)"
              >
                <span class="chip-color-indicator" [style.background-color]="getDistressColor(distress.name)"></span>
                {{ distress.name }}
                <i *ngIf="isDistressSelectedForMonthComparison(distress.name)" class="fas fa-check"></i>
              </button>
            </div>
          </div>

          <div class="comparison-chart-container">
            <div *ngIf="selectedDistressesForMonthComparison.length === 0" class="no-assets-selected">
              <p>Please select at least one distress type to view the month-wise comparison chart</p>
            </div>
            <div *ngIf="isLoadingMonthChart" class="loading-chart">
              <div class="loading-spinner"></div>
              <p>Loading month-wise data...</p>
            </div>
            <div
              *ngIf="!isLoadingMonthChart && selectedDistressesForMonthComparison.length > 0 && monthComparisonChartOptions && monthComparisonChartOptions.series"
              echarts
              [options]="monthComparisonChartOptions"
              class="comparison-echarts-chart"
              style="width: 100%; height: 500px;"
            ></div>
          </div>
        </div>
      </div>
    </div>
    </div>

  <!-- Pothole Detection Modal -->
  <div *ngIf="isPotholeModalOpen" class="modal-overlay" (click)="closePotholeModal()">
    <div class="pothole-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <i class="fas fa-road"></i>
          Distress Detection Analysis
        </h3>
        <button class="modal-close-btn" (click)="closePotholeModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="pothole-modal-body">
        

        <!-- Charts Container -->
        <div class="pothole-charts-container">
          <!-- Depth Chart -->
          <div class="pothole-chart-wrapper">
            <div class="chart-header">
              <h4>
                <i class="fas fa-chart-line"></i>
                Laser Line Profile - Distress Depth Detection
              </h4>
            </div>
            <div class="pothole-chart">
              <div
                *ngIf="potholeDepthChartOptions"
                echarts
                [options]="potholeDepthChartOptions"
                [loading]="isLoadingPotholeData"
                class="pothole-echarts-chart"
                [autoResize]="true"
              ></div>
            </div>
          </div>

          <!-- Segment Navigation -->
        <div class="segment-navigation">
          <button 
            class="nav-btn prev-btn" 
            (click)="goToPreviousSegment()"
            [disabled]="!canGoToPreviousSegment()"
            title="Previous 10m segment"
          >
            <i class="fas fa-chevron-left"></i>
            <span>Previous</span>
          </button>
          
          <div class="segment-info">
            <span class="segment-label">Segment {{ currentSegmentIndex + 1 }} of {{ totalSegments }}</span>
            <span class="segment-range">{{ getCurrentSegmentInfo() }}</span>
          </div>
          
          <button 
            class="nav-btn next-btn" 
            (click)="goToNextSegment()"
            [disabled]="!canGoToNextSegment()"
            title="Next 10m segment"
          >
            <span>Next</span>
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

          <!-- Area Distribution Chart with Polygons -->
          <div class="pothole-chart-wrapper pothole-area-wrapper">
            <div class="chart-header">
              <h4>
                <i class="fas fa-draw-polygon"></i>
                Distress Area Distribution
              </h4>
            </div>
            <div class="pothole-chart">
              <div
                echarts
                [options]="potholeAreaChartOptions"
                [loading]="isLoadingPotholeData"
                class="pothole-echarts-chart pothole-area-chart"
              ></div>
            </div>
          </div>
        </div>

        <!-- 3D Road Surface View -->
        <!-- <div class="road-3d-view-wrapper"> -->
          <!-- <div class="view-toggle-buttons">
            <button 
              class="view-btn" 
              [class.active]="currentView === 'top'"
              (click)="switchView('top')"
            >
              <i class="fas fa-border-all"></i>
              Top View
            </button>
            <button 
              class="view-btn" 
              [class.active]="currentView === 'side'"
              (click)="switchView('side')"
            >
              <i class="fas fa-chart-area"></i>
              Side View
            </button>
            <button 
              class="view-btn" 
              [class.active]="currentView === '3d'"
              (click)="switchView('3d')"
            >
              <i class="fas fa-cube"></i>
              3D View
            </button>
          </div> -->

          <!-- Top View -->
          <!-- <div class="pothole-chart-wrapper" *ngIf="currentView === 'top'">
            <div class="chart-header">
              <h4>
                <i class="fas fa-border-all"></i>
                Road Surface - Top View
              </h4>
              <p class="chart-description">
                Bird's eye view of the road surface. Darker colors indicate deeper potholes.
              </p>
            </div>
            <div class="pothole-chart">
              <div
                *ngIf="potholeTopViewOptions"
                echarts
                [options]="potholeTopViewOptions"
                [loading]="isLoadingPotholeData"
                class="pothole-echarts-chart"
                [autoResize]="true"
              ></div>
            </div>
          </div> -->

          <!-- Side View -->
          <!-- <div class="pothole-chart-wrapper" *ngIf="currentView === 'side'">
            <div class="chart-header">
              <h4>
                <i class="fas fa-chart-area"></i>
                Road Surface - Side View (Cross Section)
              </h4>
              <p class="chart-description">
                Cross-sectional view showing road profile depth along distance. Select a laser line to view.
              </p>
              <div class="laser-selector">
                <label>Select Laser Line: </label>
                <select [(ngModel)]="selectedLaserForSideView" (change)="generateSideView()">
                  <option *ngFor="let laser of availableLasersForSideView" [value]="laser">L{{ laser }}</option>
                </select>
              </div>
            </div>
            <div class="pothole-chart">
              <div
                *ngIf="potholeSideViewOptions"
                echarts
                [options]="potholeSideViewOptions"
                [loading]="isLoadingPotholeData"
                class="pothole-echarts-chart"
                [autoResize]="true"
              ></div>
            </div>
          </div> -->

          <!-- 3D View -->
          <!-- <div class="pothole-chart-wrapper" *ngIf="currentView === '3d'">
            <div class="chart-header">
              <h4>
                <i class="fas fa-cube"></i>
                Road Surface - 3D View
              </h4>
              <p class="chart-description">
                Interactive 3D surface plot. Rotate with mouse, zoom with scroll. Depressions show potholes.
              </p>
            </div>
            <div class="pothole-chart">
              <div
                *ngIf="pothole3DViewOptions"
                echarts
                [options]="pothole3DViewOptions"
                [loading]="isLoadingPotholeData"
                class="pothole-echarts-chart-3d"
                [autoResize]="true"
              ></div>
            </div>
          </div> -->
        <!-- </div> -->
      </div>
    </div>
  </div>

</div>