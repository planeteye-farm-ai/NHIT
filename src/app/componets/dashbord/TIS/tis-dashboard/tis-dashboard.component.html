<div class="dashboard-container">
  <!-- Main Content Area -->
  <!-- Dashboard Content (always show) -->
  <div>
    <!-- Filter Containers -->
    <div class="filters-container">
      <!-- Main Filters Container (80% width) -->
      <div class="main-filters-container">
        <div class="filter-row-main">
          <div class="filter-group">
            <label>Project Name:</label>
            <select
              [(ngModel)]="filters.projectName"
              (ngModelChange)="onProjectChange($event)"
              class="filter-select"
            >
              <option
                *ngFor="let project of availableProjects"
                [value]="project"
              >
                {{ project }}
              </option>
            </select>
          </div>

          <div class="filter-group">
            <label>Date:</label>
            <select
              [value]="filters.date"
              (change)="onDateChange($event)"
              class="filter-select"
            >
              <option *ngFor="let date of availableDates" [value]="date">
                {{ date }}
              </option>
            </select>
          </div>

          <div class="filter-group">
            <label>Direction:</label>
            <select
              [value]="filters.direction"
              (change)="onDirectionChange($any($event.target).value)"
              class="filter-select"
            >
              <option value="Increasing">Increasing</option>
              <option value="Decreasing">Decreasing</option>
            </select>
          </div>

          <!-- Pavement Type and Lane filters hidden for TIS API as they are not available in TIS data -->
          <!-- <div class="filter-group">
            <label>Pavement Type:</label>
            <select [value]="filters.pavementType" (change)="onPavementTypeChange($event)" class="filter-select">
              <option value="All">All</option>
              <option *ngFor="let type of availablePavementTypes" [value]="type">{{ type }}</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Lane:</label>
            <select [value]="filters.lane" (change)="onLaneChange($event)" class="filter-select">
              <option value="All">All</option>
              <option *ngFor="let lane of availableLanes" [value]="lane">{{ lane }}</option>
            </select>
          </div> -->

          <div class="filter-group chainage-range-group">
            <!-- <label class="chainage-range-label"
              >Chainage: {{ filters.chainageRange.min.toFixed(3) }} -
              {{ filters.chainageRange.max.toFixed(3) }}</label
            > -->
            <div class="chainage-inputs">
              <input
                type="number"
                [min]="getChainageMin()"
                [max]="filters.chainageRange.max"
                [value]="filters.chainageRange.min"
                (input)="onChainageMinChange($event)"
                class="chainage-input"
                step="0.001"
              />
              <input
                type="number"
                [min]="filters.chainageRange.min"
                [max]="getChainageMax()"
                [value]="filters.chainageRange.max"
                (input)="onChainageMaxChange($event)"
                class="chainage-input"
                step="0.001"
              />
            </div>
            <div class="chainage-slider-container">
              <input
                type="range"
                [min]="getChainageMin()"
                [max]="getChainageMax()"
                [value]="filters.chainageRange.min"
                (input)="onChainageMinSliderChange($event)"
                class="chainage-slider"
              />
              <input
                type="range"
                [min]="getChainageMin()"
                [max]="getChainageMax()"
                [value]="filters.chainageRange.max"
                (input)="onChainageMaxSliderChange($event)"
                class="chainage-slider"
              />
            </div>
          </div>

          <!-- <div class="filter-group">
            <label>Distress Type:</label>
            <select [value]="filters.distressType" (change)="onDistressTypeChange($event)" class="filter-select">
              <option value="All">All</option>
              <option *ngFor="let type of availableDistressTypes" [value]="type">{{ type }}</option>
            </select>
          </div> -->
        </div>
      </div>
    </div>

    <!-- Mobile Sidebar Toggle -->
    <!-- <button class="sidebar-toggle" (click)="toggleSidebar()">
      <span class="hamburger-icon">☰</span>
    </button> -->

    <!-- Mobile Sidebar Overlay -->
    <div
      class="sidebar-overlay"
      [class.active]="isSidebarOpen"
      (click)="toggleSidebar()"
    ></div>

    <!-- Main Dashboard Container -->
    <div class="main-dashboard-container">
      <!-- Left Panel (70% width) -->
      <div class="left-panel">
        <!-- Chainage Wise Distress Chart -->
        <!-- <div class="chart-container">
          <div class="chart-wrapper">
            <div echarts [options]="chartOptions" class="echarts-chart"></div>
          </div>
        </div> -->

        <!-- Error Message -->
        <div
          class="traffic-error"
          *ngIf="trafficError"
          style="
            padding: 10px;
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 8px;
            color: #f44336;
            margin-bottom: 10px;
          "
        >
          {{ trafficError }}
        </div>

        <!-- Actual Distress Map -->
        <div class="map-container" #mapContainerWrapper>
          <div class="chart-header">
            <h3>Location wise TIS Distribution</h3>
            <button 
              class="comparison-chart-btn fullscreen-map-btn"
              (click)="toggleMapFullScreen()"
              [title]="isMapFullScreen ? 'Exit full screen' : 'Full screen map'"
            >
              <i class="fas" [ngClass]="isMapFullScreen ? 'fa-compress' : 'fa-expand'"></i>
              {{ isMapFullScreen ? 'Exit full screen' : 'Full screen' }}
            </button>
            <button
              class="btn-traffic-analysis"
              (click)="openTrafficAnalysisModal()"
              [disabled]="
                isFetchingTraffic || !filters.date || !filters.projectName
              "
              [class.loading]="isFetchingTraffic"
            >
              <i
                class="fas"
                [class.fa-spinner]="isFetchingTraffic"
                [class.fa-spin]="isFetchingTraffic"
                [class.fa-route]="!isFetchingTraffic"
              ></i>
              <span *ngIf="!isFetchingTraffic">Live Traffic Analysis</span>
              <span *ngIf="isFetchingTraffic">Fetching Traffic Data...</span>
            </button>
          </div>
          <div class="map-wrapper">
            <div class="section-loading-overlay" *ngIf="isLoading">
              <div class="section-loading-content">
                <div class="loading-spinner small"></div>
                <p>Loading map data…</p>
              </div>
            </div>
            <div *ngIf="!filters.date" class="map-placeholder">
              <p>Select a date to view map data</p>
            </div>
            <div
              *ngIf="filters.date && rawData.length === 0"
              class="map-placeholder"
            >
              <div class="loading-spinner"></div>
              <p>Loading map data...</p>
            </div>
            <div *ngIf="filters.date" id="mapContainer" class="map">
              <!-- Traffic Analysis Overlay on Map -->
              <div
                class="traffic-analysis-overlay"
                *ngIf="
                  showTrafficAnalysis &&
                  routeData &&
                  routeData.segments &&
                  routeData.segments.length > 0
                "
              >
                <!-- <div class="traffic-analysis-panel">
                  <h6>Traffic Analysis</h6>

                  <div class="traffic-route-info">
                    <div class="traffic-route-row">
                      <strong>Date & Time:</strong> {{ routeData.date_times }}
                    </div>
                  </div>

                  <div class="traffic-stats-panel">
                    <div class="traffic-stat-row">
                      <div class="traffic-stat-item">
                        <strong>Total Time:</strong>
                        {{ getTotalTimeFormatted() }} ({{
                          getTotalTimeInMinutes()
                        }}
                        minutes)
                      </div>
                      <div class="traffic-stat-item">
                        <strong>Total Distance:</strong>
                        {{ routeData.total_kms }} km
                      </div>
                      <div class="traffic-stat-item">
                        <strong>Average Time per km:</strong>
                        {{ getAverageTimePerKm() }} minutes
                      </div>
                    </div>
                  </div>
                  <div class="traffic-distribution-panel">
                    <h6>Traffic Distribution</h6>
                    <div class="traffic-density-stats">
                      <span class="traffic-status traffic-green"
                        >Free Flow: {{ trafficDensity.freeFlow }}</span
                      >
                      <span class="traffic-status traffic-yellow"
                        >Light: {{ trafficDensity.light }}</span
                      >
                      <span class="traffic-status traffic-orange"
                        >Moderate: {{ trafficDensity.moderate }}</span
                      >
                      <span class="traffic-status traffic-red"
                        >Heavy: {{ trafficDensity.heavy }}</span
                      >
                      <span class="traffic-status traffic-dark-red"
                        >Severe: {{ trafficDensity.severe }}</span
                      >
                    </div>
                    <p class="traffic-density-note">
                      <small
                        >Based on {{ routeData.segments.length }} route
                        segments</small
                      >
                    </p>
                  </div>
                </div> -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel (30% width) -->
      <div class="right-panel" [class.sidebar-open]="isSidebarOpen">
        <div class="asset-summary">
          <div class="asset-summary-header">
            <h3>Traffic Information Summary</h3>
            <button
              class="month-comparison-toggle"
              [class.active]="isMonthComparisonMode"
              [class.loading]="isPreloadingMonthData"
              (click)="toggleMonthComparisonMode()"
              title="{{
                isMonthComparisonMode
                  ? 'Click to disable month comparison mode'
                  : 'Click to enable month comparison mode'
              }}"
            >
              <i *ngIf="!isPreloadingMonthData" class="fas fa-calendar-alt"></i>
              <i
                *ngIf="isPreloadingMonthData"
                class="fas fa-spinner fa-spin"
              ></i>
              <span class="toggle-label">{{
                isMonthComparisonMode ? "ON" : "OFF"
              }}</span>
            </button>
          </div>
          <div class="asset-grid mobile-grid">
            <div class="section-loading-overlay" *ngIf="isLoading">
              <div class="section-loading-content">
                <div class="loading-spinner small"></div>
                <p>Loading traffic information…</p>
              </div>
            </div>
            <div *ngIf="!filters.date" class="asset-placeholder">
              <p>Select a date to view traffic information</p>
            </div>
            <div
              *ngIf="filters.date && rawData.length === 0"
              class="asset-placeholder"
            >
              <div class="loading-spinner"></div>
              <p>Loading traffic information...</p>
            </div>
            <div
              *ngFor="let info of trafficInfoData"
              class="asset-card clickable-card"
              [class.selected]="selectedInfoCard === info.title"
              (click)="onInfoCardClick(info)"
              style="cursor: pointer"
              title="Click to highlight on map"
            >
              <div class="asset-info">
                <div class="asset-name">{{ info.title }}</div>
                <div class="asset-count">
                  {{ info.value }}{{ info.unit ? " " + info.unit : "" }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Traffic Analysis Modal -->
<div
  *ngIf="isTrafficAnalysisModalOpen"
  class="traffic-modal-backdrop"
  (click)="closeTrafficAnalysisModal()"
>
  <div class="traffic-modal-content" (click)="$event.stopPropagation()">
    <div class="traffic-modal-header">
      <h2>Traffic Analysis</h2>
      <button class="close-btn" (click)="closeTrafficAnalysisModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Navbar with Chainage bar, Date, Time, and Get Live Traffic Button -->
    <div class="traffic-modal-navbar">
      <div class="traffic-navbar-item traffic-chainage-bar">
        <label>Chainage:</label>
        <div class="chainage-range-container">
          <div class="chainage-inputs">
            <input
              type="number"
              [min]="getChainageMin()"
              [max]="trafficAnalysisChainageRange.max"
              [value]="trafficAnalysisChainageRange.min"
              (input)="onTrafficModalChainageMinChange($event)"
              class="chainage-input"
              step="0.001"
            />
            <input
              type="number"
              [min]="trafficAnalysisChainageRange.min"
              [max]="getChainageMax()"
              [value]="trafficAnalysisChainageRange.max"
              (input)="onTrafficModalChainageMaxChange($event)"
              class="chainage-input"
              step="0.001"
            />
          </div>
          <div class="chainage-slider-container">
            <input
              type="range"
              [min]="getChainageMin()"
              [max]="getChainageMax()"
              [value]="trafficAnalysisChainageRange.min"
              (input)="onTrafficModalChainageMinSliderChange($event)"
              class="chainage-slider"
            />
            <input
              type="range"
              [min]="getChainageMin()"
              [max]="getChainageMax()"
              [value]="trafficAnalysisChainageRange.max"
              (input)="onTrafficModalChainageMaxSliderChange($event)"
              class="chainage-slider"
            />
          </div>
        </div>
      </div>
      <div class="traffic-navbar-item">
        <label>Project Date:</label>
        <span>{{ filters.date }}</span>
      </div>
      <div class="traffic-navbar-item">
        <label>Analysis Date:</label>
        <input
          type="date"
          [(ngModel)]="trafficAnalysisDate"
          class="date-input"
          (change)="onTrafficAnalysisDateChange()"
        />
      </div>
      <div class="traffic-navbar-item">
        <label>Direction:</label>
        <select
          [(ngModel)]="filters.direction"
          class="direction-select"
          (change)="onTrafficModalDirectionChange()"
        >
          <option value="Increasing">Increasing</option>
          <option value="Decreasing">Decreasing</option>
        </select>
      </div>
      <div class="traffic-navbar-item">
        <label>Time:</label>
        <input
          type="time"
          [(ngModel)]="trafficModalTime"
          class="time-input"
          (change)="onTrafficModalTimeChange()"
        />
      </div>
      <div class="traffic-navbar-item">
        <button
          class="btn-get-live-traffic"
          (click)="getLiveTraffic()"
          [disabled]="isFetchingTraffic"
          [class.loading]="isFetchingTraffic"
        >
          <i
            class="fas"
            [class.fa-spinner]="isFetchingTraffic"
            [class.fa-spin]="isFetchingTraffic"
            [class.fa-sync]="!isFetchingTraffic"
          ></i>
          <span>{{
            isFetchingTraffic ? "Fetching..." : "Get Live Traffic"
          }}</span>
        </button>
      </div>
    </div>

    <!-- Scrollable Body Container -->
    <div class="traffic-modal-body">
      <!-- Map Section - Separate Div -->
      <div class="traffic-modal-map-section">
        <div class="traffic-modal-map-container">
          <div id="trafficModalMap" class="traffic-modal-map"></div>
          <div *ngIf="trafficError" class="traffic-error-message">
            {{ trafficError }}
          </div>
        </div>
      </div>

      <!-- 24hr Traffic Trend Chart Section - Below Map -->
      <div class="traffic-modal-chart-section">
        <div class="traffic-modal-chart-container">
          <div class="chart-header-section">
            <h3>24hr Traffic Trend</h3>
            <div class="traffic-stats-badges">
              <div *ngIf="totalTravelTime" class="total-time-badge">
                <i class="fas fa-hourglass-half"></i>
                <span
                  >Total Time: Avg {{ totalTravelTime.average.toFixed(1) }} min
                  (Min: {{ totalTravelTime.min.toFixed(1) }} - Max:
                  {{ totalTravelTime.max.toFixed(1) }} min)</span
                >
              </div>
              <div *ngIf="bestTravelTime" class="best-time-badge">
                <i class="fas fa-clock"></i>
                <span
                  >Best Time: {{ bestTravelTime.time }} ({{
                    bestTravelTime.minutes.toFixed(1)
                  }}
                  min)</span
                >
              </div>
            </div>
          </div>
          <div *ngIf="isLoading24hrTrafficTrend" class="chart-loading">
            <div class="loading-spinner"></div>
            <p>Loading 24hr traffic trend...</p>
            <div
              class="progress-bar-container"
              *ngIf="trafficTrendProgress > 0"
            >
              <div
                class="progress-bar"
                [style.width.%]="trafficTrendProgress"
              ></div>
              <span class="progress-text">{{ trafficTrendProgress }}%</span>
            </div>
          </div>
          <div
            *ngIf="!isLoading24hrTrafficTrend && !has24hrTrafficData"
            class="chart-empty"
          >
            <i class="bi bi-bar-chart-line"></i>
            <p>No 24hr traffic data available</p>
          </div>
          <div
            *ngIf="!isLoading24hrTrafficTrend && has24hrTrafficData"
            class="traffic-trend-chart"
            echarts
            [options]="traffic24hrTrendChartOptions"
          ></div>
        </div>

        <!-- Future 24hr + Past Week + Past Month Traffic Chart -->
        <div class="traffic-modal-chart-container forecast-chart-container">
          <div class="chart-header-section">
            <h3>Future 24hr + Past 1 Week Traffic Forecast</h3>
            <div class="forecast-controls">
              <button
                class="btn-load-month"
                (click)="loadPastMonthTrafficData()"
                [disabled]="isLoadingMonthData || showMonthData"
                [class.loading]="isLoadingMonthData"
                [class.active]="showMonthData"
              >
                <i
                  class="fas"
                  [class.fa-spinner]="isLoadingMonthData"
                  [class.fa-spin]="isLoadingMonthData"
                  [class.fa-calendar-alt]="!isLoadingMonthData"
                ></i>
                <span>{{
                  isLoadingMonthData
                    ? "Loading..."
                    : showMonthData
                    ? "1 Month Loaded"
                    : "Load Past 1 Month"
                }}</span>
              </button>
              <div
                *ngIf="forecastBestTime"
                class="best-time-badge forecast-badge"
              >
                <i class="fas fa-clock"></i>
                <span
                  >Best Time: {{ forecastBestTime.time }} ({{
                    forecastBestTime.minutes.toFixed(1)
                  }}
                  min) {{ forecastBestTime.is24hr ? "(24hr)" : "(Past)" }}</span
                >
              </div>
            </div>
          </div>
          <div
            *ngIf="isLoadingForecastTraffic || isLoadingMonthData"
            class="chart-loading"
          >
            <div class="loading-spinner"></div>
            <p>
              {{
                isLoadingMonthData
                  ? "Loading past month traffic data..."
                  : "Loading forecast traffic data..."
              }}
            </p>
            <div class="progress-bar-container" *ngIf="forecastProgress > 0">
              <div
                class="progress-bar"
                [style.width.%]="forecastProgress"
              ></div>
              <span class="progress-text">{{ forecastProgress }}%</span>
            </div>
          </div>
          <div
            *ngIf="
              !isLoadingForecastTraffic &&
              !isLoadingMonthData &&
              !hasForecastTrafficData
            "
            class="chart-empty"
          >
            <i class="bi bi-bar-chart-line"></i>
            <p>No forecast traffic data available</p>
          </div>
          <div
            *ngIf="
              !isLoadingForecastTraffic &&
              !isLoadingMonthData &&
              hasForecastTrafficData
            "
            class="traffic-trend-chart forecast-chart"
            echarts
            [options]="trafficForecastChartOptions"
          ></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Month Comparison Modal -->
<div
  *ngIf="isMonthComparisonModalOpen"
  class="comparison-modal-backdrop"
  (click)="closeMonthComparisonModal()"
>
  <div class="comparison-modal-content" (click)="$event.stopPropagation()">
    <div class="comparison-modal-header">
      <h2>
        {{
          selectedMetricsForMonthComparison.length === 1
            ? selectedMetricsForMonthComparison[0]
            : "Traffic Metrics"
        }}
        - Month-wise Comparison
      </h2>
      <button class="close-btn" (click)="closeMonthComparisonModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="comparison-modal-body">
      <!-- Metric Selection -->
      <div class="asset-selection-section" *ngIf="showMetricSelectionInModal">
        <h3>Select Metrics to Compare (Max 5)</h3>
        <div class="asset-chips-container">
          <div
            *ngFor="
              let metric of [
                'AADT in Vehicles',
                'CVD in Vehicles',
                'AADT in PCU',
                'Car/ Jeep/ Van/ Taxi',
                '3 Axle Trucks',
                '2 Axle Trucks',
                'MAV',
                'OSV',
                'LCV',
                'Standard Bus'
              ]
            "
            class="asset-chip"
            [class.selected]="isMetricSelectedForMonthComparison(metric)"
            [style.border-color]="getMetricColor(metric)"
            [style.background-color]="
              getMetricChipBackgroundColorForMonth(metric)
            "
            (click)="toggleMetricForMonthComparison(metric)"
          >
            <span
              class="chip-color-indicator"
              [style.background-color]="getMetricColor(metric)"
            ></span>
            <span class="chip-label">{{ metric }}</span>
            <i
              class="bi bi-check-circle-fill chip-checkmark"
              *ngIf="isMetricSelectedForMonthComparison(metric)"
            ></i>
          </div>
        </div>
      </div>

      <!-- Chart Container -->
      <div class="comparison-chart-container">
        <div *ngIf="isLoadingMonthChart" class="chart-loading">
          <div class="loading-spinner"></div>
          <p>Loading month-wise data...</p>
        </div>

        <div
          *ngIf="
            !isLoadingMonthChart &&
            selectedMetricsForMonthComparison.length === 0
          "
          class="chart-empty"
        >
          <i class="bi bi-bar-chart-line"></i>
          <p>Please select at least one metric to compare</p>
        </div>

        <div
          *ngIf="
            !isLoadingMonthChart && selectedMetricsForMonthComparison.length > 0
          "
          class="comparison-echarts-chart"
          echarts
          [options]="monthComparisonChartOptions"
          [loading]="isLoadingMonthChart"
        ></div>
      </div>

      <!-- Info Banner -->
      <div
        class="chart-info"
        *ngIf="
          !isLoadingMonthChart && selectedMetricsForMonthComparison.length > 0
        "
      >
        <i class="bi bi-info-circle"></i>
        <span
          >Showing {{ selectedMetricsForMonthComparison.length }} metric(s)
          across {{ availableMonthsForComparison.length }} month(s)</span
        >
      </div>
    </div>
  </div>
</div>
